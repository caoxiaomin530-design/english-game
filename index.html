<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‹±è¯­å•è¯é­”æ³•é—¯å…³</title>
    <style>
        /* é­”æ³•æ˜Ÿç©ºèƒŒæ™¯ */
        body {
            background: radial-gradient(circle at bottom, #1b2735 0%, #090a0f 100%);
            color: #fff;
            font-family: sans-serif;
            text-align: center;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
        }
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .stars::after { content: "."; position: absolute; top: 10%; left: 20%; font-size: 20px; color: yellow; opacity: 0.5; box-shadow: 100px 200px 0 white, 200px 50px 0 yellow, -50px 300px 0 white; animation: twinkle 5s infinite; }
        @keyframes twinkle { 50% { opacity: 0.2; transform: scale(0.8); } }
        
        #game-stage { position: relative; width: 100vw; height: 100vh; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* èœå•æ ·å¼ */
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(9, 10, 15, 0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; padding-top: 40px; overflow-y: auto; }
        h1 { color: #ffd700; font-size: 28px; text-shadow: 0 0 10px #ff9900; margin-bottom: 5px; }
        .subtitle { color: #888; font-size: 14px; margin-bottom: 20px; }
        
        #unit-list { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 90%; max-width: 500px; padding-bottom: 50px; }
        .unit-btn { padding: 15px; font-size: 16px; background: #2c3e50; color: #ffd700; border: 2px solid #f39c12; cursor: pointer; border-radius: 12px; font-weight: bold; transition: transform 0.1s; }
        .unit-btn:active { transform: scale(0.95); background: #34495e; }
        
        /* å­¦ä¹ åŒºåŸŸæ ·å¼ */
        #center-display { width: 90%; max-width: 600px; display: flex; flex-direction: column; align-items: center; }
        .big-word { font-size: 40px; color: #f1c40f; font-weight: bold; margin: 15px 0; line-height: 1.2; text-shadow: 2px 2px 0 #000; }
        .hint-text { font-size: 24px; color: #ecf0f1; margin-bottom: 25px; }
        
        .option-btn { width: 100%; padding: 16px; margin: 8px 0; background: rgba(255, 255, 255, 0.1); border: 2px solid #bdc3c7; color: white; font-size: 18px; cursor: pointer; border-radius: 50px; backdrop-filter: blur(5px); }
        .correct { background: #27ae60 !important; border-color: #2ecc71 !important; }
        .wrong { background: #c0392b !important; border-color: #e74c3c !important; }
        
        #hud { position: absolute; top: 0; width: 100%; padding: 10px 20px; background: rgba(0,0,0,0.6); display: flex; justify-content: space-between; color: #ffd700; font-size: 15px; box-sizing: border-box; }
        
        /* æˆ˜æ–—å±‚æ ·å¼ */
        #combat-layer { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 50; }
        #player { font-size: 50px; position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); text-shadow: 0 0 20px blue; }
        .enemy { position: absolute; color: #e74c3c; font-weight: bold; font-size: 24px; background: rgba(255,255,255,0.9); padding: 8px 15px; border-radius: 8px; box-shadow: 0 0 10px red; }
        .bullet { width: 12px; height: 12px; background: #2ecc71; border-radius: 50%; position: absolute; box-shadow: 0 0 10px #2ecc71; }
        
        #input-area { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; }
        #answer-input { width: 75%; padding: 12px; font-size: 20px; text-align: center; border-radius: 25px; border: 3px solid #f1c40f; background: rgba(0,0,0,0.85); color: white; outline: none; }
    </style>
</head>
<body>
    <div class="stars"></div>

    <div id="game-stage">
        <div id="menu-screen">
            <h1>[ENGLISH] å•è¯é­”æ³•ç‰¹è®­</h1>
            <div class="subtitle">æ²ªæ•™ç‰ˆå››ä¸‹ Â· å…¨å•å…ƒ Â· æ™ºèƒ½ç‰ˆ</div>
            <div id="unit-list"></div>
            <div style="margin-top:20px; color:#666; font-size:12px;">å¦‚æœçœ‹ä¸åˆ°æŒ‰é’®ï¼Œè¯·åˆ·æ–°é¡µé¢</div>
        </div>

        <div id="hud" style="display:none;">
            <div onclick="location.reload()" style="cursor:pointer; border:1px solid #666; padding:2px 8px; border-radius:5px;"> Back (é€€å‡º)</div>
            <div id="stage-info">Step 1</div>
            <div>Score: <span id="score">0</span></div>
        </div>

        <div id="center-display" style="display:none;">
            <div id="display-content"></div>
            <div id="status-text" style="height:25px; color:#aaa; font-size:14px; margin-bottom: 5px;"></div>
            <div id="options-container" style="display:flex; flex-direction:column; align-items:center; width:100%;"></div>
        </div>

        <div id="combat-layer">
            <div id="player">ğŸ§™â€â™‚ï¸</div>
            <div id="input-area">
                <input type="text" id="answer-input" placeholder="è¾“å…¥å•è¯å‘å°„å­å¼¹..." autocomplete="off">
            </div>
        </div>
    </div>

<script>
    // å®Œæ•´è¯åº“ (Unit 1 - Unit 8)
    const TEXTBOOK = {
        "Unit 1": [{en:"get up", cn:"èµ·åºŠ"}, {en:"have breakfast", cn:"åƒæ—©é¤"}, {en:"go to school", cn:"ä¸Šå­¦"}, {en:"have lunch", cn:"åƒåˆé¤"}, {en:"go home", cn:"å›å®¶"}, {en:"have dinner", cn:"åƒæ™šé¤"}, {en:"go to bed", cn:"ç¡è§‰"}, {en:"daily", cn:"æ—¥å¸¸çš„"}, {en:"schedule", cn:"æ—¥ç¨‹å®‰æ’"}, {en:"at", cn:"åœ¨(æŸæ—¶é—´)"}, {en:"o'clock", cn:"...ç‚¹é’Ÿ"}, {en:"half", cn:"...ç‚¹åŠ"}, {en:"little", cn:"å¹´å¹¼çš„"}, {en:"drink", cn:"å–; é¥®"}, {en:"lesson", cn:"è¯¾"}, {en:"draw", cn:"ç”»"}, {en:"quarter", cn:"ä¸€åˆ»é’Ÿ"}, {en:"Miss", cn:"å°å§"}, {en:"brush my teeth", cn:"åˆ·ç‰™"}, {en:"wash my face", cn:"æ´—è„¸"}],
        "Unit 2": [{en:"Chinese", cn:"è¯­æ–‡"}, {en:"Maths", cn:"æ•°å­¦"}, {en:"English", cn:"è‹±è¯­"}, {en:"PE", cn:"ä½“è‚²"}, {en:"Music", cn:"éŸ³ä¹"}, {en:"Art", cn:"ç¾æœ¯"}, {en:"IT", cn:"ä¿¡æ¯æŠ€æœ¯"}, {en:"Science", cn:"ç§‘å­¦"}, {en:"club", cn:"ç¤¾å›¢"}, {en:"student", cn:"å­¦ç”Ÿ"}, {en:"different", cn:"ä¸åŒçš„"}, {en:"subject", cn:"ç§‘ç›®"}, {en:"class", cn:"ç­çº§;è¯¾"}, {en:"pig", cn:"çŒª"}, {en:"timetable", cn:"æ—¶é—´è¡¨"}, {en:"work out", cn:"ç®—å‡º"}, {en:"model plane", cn:"é£æœºæ¨¡å‹"}],
        "Unit 3": [{en:"firefighter", cn:"æ¶ˆé˜²å‘˜"}, {en:"police officer", cn:"è­¦å¯Ÿ"}, {en:"farmer", cn:"å†œå¤«"}, {en:"teacher", cn:"è€å¸ˆ"}, {en:"doctor", cn:"åŒ»ç”Ÿ"}, {en:"bus driver", cn:"å¸æœº"}, {en:"fire", cn:"ç«"}, {en:"sick", cn:"ç”Ÿç—…çš„"}, {en:"soup", cn:"æ±¤"}, {en:"Mrs", cn:"å¤«äºº"}, {en:"job", cn:"å·¥ä½œ"}, {en:"people", cn:"äººä»¬"}, {en:"know", cn:"çŸ¥é“"}, {en:"dentist", cn:"ç‰™åŒ»"}, {en:"hospital", cn:"åŒ»é™¢"}, {en:"nurse", cn:"æŠ¤å£«"}, {en:"check", cn:"æ£€æŸ¥"}],
        "Unit 4": [{en:"triangle", cn:"ä¸‰è§’é“"}, {en:"violin", cn:"å°æç´"}, {en:"piano", cn:"é’¢ç´"}, {en:"guitar", cn:"å‰ä»–"}, {en:"erhu", cn:"äºŒèƒ¡"}, {en:"flute", cn:"é•¿ç¬›"}, {en:"drum", cn:"é¼“"}, {en:"woman", cn:"å¦‡å¥³"}, {en:"concert", cn:"éŸ³ä¹ä¼š"}, {en:"think", cn:"æ€è€ƒ"}, {en:"clever", cn:"èªæ˜çš„"}, {en:"idea", cn:"æƒ³æ³•"}, {en:"beautiful", cn:"ç¾å¦™çš„"}],
        "Unit 5": [{en:"paper-cut", cn:"å‰ªçº¸"}, {en:"painting", cn:"ç»˜ç”»"}, {en:"circle", cn:"åœ†å½¢"}, {en:"square", cn:"æ­£æ–¹å½¢"}, {en:"star", cn:"æ˜Ÿæ˜Ÿ"}, {en:"rectangle", cn:"é•¿æ–¹å½¢"}, {en:"clock", cn:"é’Ÿ"}, {en:"shape", cn:"å½¢çŠ¶"}, {en:"side", cn:"è¾¹"}, {en:"ask", cn:"é—®"}, {en:"tiger", cn:"è€è™"}, {en:"say", cn:"è¯´"}],
        "Unit 6": [{en:"day", cn:"ç™½å¤©"}, {en:"night", cn:"å¤œæ™š"}, {en:"hour", cn:"å°æ—¶"}, {en:"minute", cn:"åˆ†é’Ÿ"}, {en:"second", cn:"ç§’"}, {en:"month", cn:"æœˆä»½"}, {en:"year", cn:"å¹´"}, {en:"measure", cn:"æµ‹é‡"}, {en:"question", cn:"é—®é¢˜"}, {en:"exercise", cn:"è¿åŠ¨"}],
        "Unit 7": [{en:"liquid", cn:"æ¶²ä½“"}, {en:"solid", cn:"å›ºä½“"}, {en:"gas", cn:"æ°”ä½“"}, {en:"sugar", cn:"ç³–"}, {en:"salt", cn:"ç›"}, {en:"melt", cn:"èåŒ–"}, {en:"steam", cn:"æ°´è’¸æ°”"}, {en:"heat", cn:"åŠ çƒ­"}, {en:"hungry", cn:"é¥¿çš„"}, {en:"ice cream", cn:"å†°æ·‡æ·‹"}, {en:"freezer", cn:"å†°æŸœ"}, {en:"mix", cn:"æ··åˆ"}],
        "Unit 8": [{en:"polite", cn:"æœ‰ç¤¼è²Œçš„"}, {en:"take turns", cn:"è½®æµ"}, {en:"knock", cn:"æ•²"}, {en:"ox", cn:"å…¬ç‰›"}, {en:"until", cn:"ç›´åˆ°..."}, {en:"invite", cn:"é‚€è¯·"}, {en:"behind", cn:"åœ¨...åé¢"}, {en:"cry", cn:"å“­"}, {en:"kind", cn:"å‹å–„çš„"}, {en:"helpful", cn:"ä¹äºåŠ©äººçš„"}]
    };
    
    // æ¸¸æˆå˜é‡
    let queue=[], qIndex=0, step=1, score=0, recognition=null, isMobile=false;
    const synth = window.speechSynthesis;

    // æ™ºèƒ½ç¯å¢ƒæ£€æµ‹ï¼ˆæ‰‹æœº/ç”µè„‘ï¼‰
    function checkEnv(){
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SR){
            try{ recognition = new SR(); recognition.lang='en-US'; recognition.continuous=false; }
            catch(e){ recognition=null; }
        }
        // å¦‚æœæ˜¯æ‰‹æœºæˆ–è€…æ²¡æœ‰è¯­éŸ³åŠŸèƒ½ï¼Œå¼€å¯æ‰‹æœºæ¨¡å¼
        if(!recognition || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
            isMobile = true;
        }
    }

    // ç¡®ä¿é¡µé¢åŠ è½½åç”ŸæˆæŒ‰é’®
    window.onload = function() {
        checkEnv();
        const list = document.getElementById('unit-list');
        for(let u in TEXTBOOK){
            let btn = document.createElement('div');
            btn.className = 'unit-btn';
            btn.innerText = u;
            btn.onclick = () => startGame(u);
            list.appendChild(btn);
        }
    };

    function startGame(u){
        document.getElementById('menu-screen').style.display='none';
        document.getElementById('hud').style.display='flex';
        document.getElementById('center-display').style.display='flex';
        queue = TEXTBOOK[u];
        qIndex = 0; step = 1; score = 0;
        loadLevel();
    }

    function loadLevel(){
        if(qIndex >= queue.length){
            if(step < 4){
                step++; qIndex = 0; 
                alert("å¤ªæ£’äº†ï¼å‡çº§åˆ°ç¬¬ " + step + " å…³ (Step " + step + ")!");
                loadLevel();
            } else {
                alert("ğŸ‰ æ­å–œï¼æœ¬å•å…ƒå…¨éƒ¨é€šå…³ï¼");
                location.reload();
            }
            return;
        }
        
        const t = ["", "Step 1: è®°å¿† (Memory)", "Step 2: è¾¨ä¹‰ (Listen)", "Step 3: äº’è¯‘ (Meaning)", "Step 4: æ‹¼å†™ (Spell)"];
        document.getElementById('stage-info').innerText = t[step];
        document.getElementById('score').innerText = score;
        
        document.getElementById('display-content').innerHTML='';
        document.getElementById('options-container').innerHTML='';
        document.getElementById('status-text').innerText='';
        document.getElementById('center-display').style.display='flex';
        document.getElementById('combat-layer').style.display='none';
        
        const w = queue[qIndex];
        if(step===1) runStep1(w);
        else if(step===2) runStep2(w);
        else if(step===3) runStep3(w);
        else if(step===4) runStep4(w);
    }

    function speak(t){
        if(synth.speaking) synth.cancel();
        let u = new SpeechSynthesisUtterance(t);
        u.lang = 'en-US';
        synth.speak(u);
    }

    // Step 1: è®°å¿†/è·Ÿè¯»
    function runStep1(w){
        document.getElementById('display-content').innerHTML = '<div class="big-word">'+w.en+'</div><div class="hint-text">'+w.cn+'</div>';
        setTimeout(()=>speak(w.en), 300);
        let c = document.getElementById('options-container');
        
        if(isMobile){
            // æ‰‹æœºç«¯ï¼šç›´æ¥æ˜¾ç¤ºè®°ä½äº†
            document.getElementById('status-text').innerText = "è¯·å¬éŸ³è®°å¿† (Listen & Memorize)";
            let b = document.createElement('div');
            b.className = 'option-btn';
            b.innerText = "âœ… æˆ‘è®°ä½äº† (Next)";
            b.style.background = "#2980b9";
            b.onclick = ()=>{ score+=5; next(); };
            c.appendChild(b);
        } else {
            // ç”µè„‘ç«¯ï¼šæ˜¾ç¤ºè·Ÿè¯»
            document.getElementById('status-text').innerText = "è¯·å¤§å£°è·Ÿè¯» (Read Aloud)";
            let b = document.createElement('div');
            b.className = 'option-btn';
            b.innerText = "ğŸ™ï¸ ç‚¹å‡»è·Ÿè¯»";
            let s = document.getElementById('status-text');
            b.onclick = ()=>{
                b.style.background = "#f39c12"; b.innerText = "ğŸ‘‚ æ­£åœ¨å¬...";
                try{ recognition.start(); } catch(e){}
                recognition.onresult = (e)=>{
                    let t = e.results[0][0].transcript.toLowerCase();
                    if(t.includes(w.en.toLowerCase()) || t.length>0){
                        s.innerText = "Excellent!"; score+=10; setTimeout(next, 800);
                    }
                };
            };
            c.appendChild(b);
            let k = document.createElement('div'); k.innerText="Pass (è·³è¿‡)"; k.style.color="#888"; k.style.marginTop="10px"; k.style.cursor="pointer"; k.onclick=next; c.appendChild(k);
        }
    }

    // Step 2: å¬éŸ³è¾¨ä¹‰
    function runStep2(w){
        document.getElementById('display-content').innerHTML = '<div style="font-size:60px; margin:20px 0; cursor:pointer" onclick="speak(\''+w.en+'\')">ğŸ”Š</div>';
        document.getElementById('status-text').innerText = "å¬éŸ³é€‰ä¹‰ (Listen & Choose)";
        speak(w.en);
        getOpts(w, 'cn').forEach(o=>{
            let b = document.createElement('div'); b.className='option-btn'; b.innerText=o.cn;
            b.onclick = ()=>{
                if(o===w){ b.classList.add('correct'); score+=10; setTimeout(next,500); }
                else { b.classList.add('wrong'); speak("No"); }
            };
            document.getElementById('options-container').appendChild(b);
        });
    }

    // Step 3: äº’è¯‘
    function runStep3(w){
        document.getElementById('display-content').innerHTML = '<div class="big-word">'+w.cn+'</div>';
        getOpts(w, 'en').forEach(o=>{
            let b = document.createElement('div'); b.className='option-btn'; b.innerText=o.en;
            b.onclick = ()=>{
                if(o===w){ b.classList.add('correct'); speak(w.en); score+=10; setTimeout(next,500); }
                else { b.classList.add('wrong'); }
            };
            document.getElementById('options-container').appendChild(b);
        });
    }

    // Step 4: æ‹¼å†™å°„å‡»
    function runStep4(w){
        document.getElementById('center-display').style.display='none';
        document.getElementById('combat-layer').style.display='block';
        let i = document.getElementById('answer-input'); i.value=''; i.focus();
        let e = document.createElement('div'); e.className='enemy'; e.innerText=w.cn;
        e.style.top='100px'; 
        // ä¿®æ­£ï¼šç¡®ä¿æ•Œäººä¸ä¼šè·‘å‡ºå±å¹•è¾¹ç¼˜
        e.style.left = (Math.random()*(window.innerWidth-200) + 50)+"px";
        document.getElementById('combat-layer').appendChild(e);

        const chk = ()=>{
            if(i.value.trim().toLowerCase() === w.en.toLowerCase()){
                let b = document.createElement('div'); b.className='bullet';
                b.style.bottom='130px'; b.style.left='50%';
                document.getElementById('combat-layer').appendChild(b);
                
                // å­å¼¹é£è¡ŒåŠ¨ç”»
                setTimeout(()=>{
                    b.style.transition = "top 0.2s, left 0.2s";
                    b.style.top = e.style.top;
                    b.style.left = e.style.left;
                    setTimeout(()=>{
                        e.remove(); b.remove(); speak(w.en); score+=20; next();
                    }, 200);
                }, 10);
            }
        };
        i.onkeypress=(evt)=>{ if(evt.key==='Enter') chk(); };
        i.oninput=()=>{ if(i.value.trim().toLowerCase() === w.en.toLowerCase()) chk(); };
    }

    function next(){ qIndex++; loadLevel(); }
    function getOpts(c, k){
        let a = [c];
        while(a.length<3){
            let r = queue[Math.floor(Math.random()*queue.length)];
            if(!a.includes(r)) a.push(r);
        }
        return a.sort(()=>Math.random()-0.5);
    }
</script>
</body>
</html>
