<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éœæ ¼æ²ƒèŒ¨å•è¯è¯•ç‚¼</title>
    <style>
        :root { --gold: #ffd700; --wizard-blue: #1a237e; --magic-green: #00ff00; }
        body {
            background: radial-gradient(circle at bottom, #1b2735 0%, #090a0f 100%);
            color: #fff; font-family: "PingFang SC", sans-serif;
            margin: 0; overflow: hidden; touch-action: manipulation;
        }

        /* æ¸¸æˆå®¹å™¨ */
        #game-stage { width: 100vw; height: 100vh; position: relative; display: flex; flex-direction: column; align-items: center; }

        /* é¡¶éƒ¨ HUD */
        #hud {
            width: 100%; padding: 10px 20px; background: rgba(0,0,0,0.7);
            display: none; justify-content: space-between; align-items: center;
            color: var(--gold); box-sizing: border-box; z-index: 100;
        }

        /* èœå•ç•Œé¢ */
        #menu-screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 200; display: flex; flex-direction: column; align-items: center; padding-top: 50px;
        }
        .unit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; max-width: 400px; }
        .unit-btn { 
            padding: 15px; background: #3b1e54; color: var(--gold); 
            border: 2px solid var(--gold); cursor: pointer; border-radius: 12px; font-weight: bold;
        }

        /* æ ¸å¿ƒäº¤äº’åŒº */
        #content-area { width: 90%; max-width: 600px; text-align: center; margin-top: 80px; z-index: 10; }
        .big-word { font-size: 50px; color: var(--gold); margin: 20px 0; }
        .step-hint { font-size: 18px; color: #aaa; margin-bottom: 20px; }
        .btn {
            width: 80%; padding: 15px; margin: 10px 0; background: rgba(255,255,255,0.1);
            border: 2px solid #fff; color: #fff; font-size: 20px; border-radius: 50px; cursor: pointer;
        }
        .correct { background: #27ae60 !important; }
        .wrong { background: #c0392b !important; animation: shake 0.3s; }

        /* é­”æ³•æˆ˜æ–—åœºé¢ (Step 4) */
        #combat-zone { display: none; width: 100%; height: 100%; position: absolute; top: 0; }
        #harry { font-size: 60px; position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); transition: 0.2s; }
        .enemy-word { 
            position: absolute; background: #fff; color: #000; padding: 10px 20px; 
            border-radius: 8px; font-weight: bold; font-size: 24px; box-shadow: 0 0 20px var(--gold);
        }
        .spell-bullet { 
            width: 15px; height: 15px; background: var(--magic-green); border-radius: 50%; 
            position: absolute; box-shadow: 0 0 20px var(--magic-green); z-index: 60;
        }
        #input-box { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; }
        #spell-input { 
            width: 80%; padding: 15px; font-size: 22px; border: 3px solid var(--gold); 
            background: #000; color: #fff; border-radius: 30px; text-align: center;
        }
        .misfire { border-color: #ff0000 !important; animation: shake 0.5s; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    </style>
</head>
<body>

<div id="game-stage">
    <div id="menu-screen">
        <h1>éœæ ¼æ²ƒèŒ¨å•è¯è¯¾</h1>
        <p style="color:#888; margin-bottom: 30px;">æ²ªæ•™ç‰ˆå››ä¸‹ Â· é­”æ³•é—¯å…³</p>
        <div id="unit-list" class="unit-grid"></div>
    </div>

    <div id="hud">
        <div onclick="location.reload()">é€€å‡º</div>
        <div id="stage-info">æ­£åœ¨åŠ è½½</div>
        <div id="group-progress">ç¬¬ 1/4 ç»„</div>
    </div>

    <div id="content-area">
        <div id="display-text"></div>
        <div id="options-container"></div>
        <div id="step-hint" class="step-hint"></div>
    </div>

    <div id="combat-zone">
        <div id="harry">ğŸ§™â€â™‚ï¸</div>
        <div id="input-box">
            <input type="text" id="spell-input" placeholder="è¾“å…¥å•è¯æ‹¼å†™..." autocomplete="off">
        </div>
    </div>
</div>

<script>
    // è¯åº“é…ç½® (æ‚¨å¯ä»¥ç»§ç»­æ·»åŠ )
    const DATA = {
        "Unit 1": [
            {en:"get up", cn:"èµ·åºŠ"}, {en:"have breakfast", cn:"åƒæ—©é¤"}, {en:"go to school", cn:"ä¸Šå­¦"}, {en:"have lunch", cn:"åƒåˆé¤"}, {en:"go home", cn:"å›å®¶"},
            {en:"have dinner", cn:"åƒæ™šé¤"}, {en:"go to bed", cn:"ç¡è§‰"}, {en:"daily", cn:"æ—¥å¸¸çš„"}, {en:"schedule", cn:"æ—¥ç¨‹å®‰æ’"}, {en:"at", cn:"åœ¨"}
        ],
        "Unit 2": [
            {en:"Chinese", cn:"è¯­æ–‡"}, {en:"Maths", cn:"æ•°å­¦"}, {en:"English", cn:"è‹±è¯­"}, {en:"PE", cn:"ä½“è‚²"}, {en:"Music", cn:"éŸ³ä¹"}
        ]
    };

    let state = {
        unitWords: [],
        groupWords: [],
        currentGroupIdx: 0,
        wordInGroupIdx: 0,
        step: 1, // 1:è·Ÿè¯», 2:å¬éŸ³, 3:çœ‹ä¸­è¯´è‹±, 4:æ‹¼å†™
        repeatCount: 0
    };

    const synth = window.speechSynthesis;

    // é¢„åŠ è½½ç®€æ˜“éŸ³æ•ˆ
    const playSound = (type) => {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);

        if (type === 'cast') { // æ–½æ³•å£°éŸ³
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(110, ctx.currentTime + 0.2);
            gain.gain.fadeOut = 0.2;
        } else if (type === 'hit') { // å‡»ä¸­å£°éŸ³
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        } else if (type === 'miss') { // å“‘ç«å£°éŸ³
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(50, ctx.currentTime + 0.5);
            gain.gain.fadeOut = 0.5;
        }
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
    };

    function init() {
        const list = document.getElementById('unit-list');
        for(let u in DATA) {
            let b = document.createElement('div');
            b.className = 'unit-btn';
            btnText = u;
            b.innerText = u;
            b.onclick = () => startUnit(u);
            list.appendChild(b);
        }
    }

    function startUnit(u) {
        state.unitWords = DATA[u];
        state.currentGroupIdx = 0;
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('hud').style.display = 'flex';
        loadGroup();
    }

    function loadGroup() {
        const start = state.currentGroupIdx * 5;
        state.groupWords = state.unitWords.slice(start, start + 5);
        state.wordInGroupIdx = 0;
        state.step = 1;
        state.repeatCount = 0;
        document.getElementById('group-progress').innerText = `ç¬¬ ${state.currentGroupIdx + 1} ç»„`;
        runStep();
    }

    function runStep() {
        const word = state.groupWords[state.wordInGroupIdx];
        const display = document.getElementById('display-text');
        const container = document.getElementById('options-container');
        const hint = document.getElementById('step-hint');
        
        container.innerHTML = '';
        document.getElementById('combat-zone').style.display = 'none';
        document.getElementById('content-area').style.display = 'block';

        if (state.step === 1) { // 1. è·Ÿè¯»3é
            document.getElementById('stage-info').innerText = "è·Ÿè¯»è®­ç»ƒ (3é)";
            display.innerHTML = `<div class="big-word">${word.en}</div><div style="font-size:24px">${word.cn}</div>`;
            hint.innerText = `è¯·è·Ÿè¯»ï¼Œå·²å®Œæˆ: ${state.repeatCount}/3`;
            
            let b = document.createElement('div');
            b.className = 'btn';
            b.innerText = "ç‚¹å‡»æœ—è¯»å•è¯";
            b.onclick = () => {
                speak(word.en);
                state.repeatCount++;
                if(state.repeatCount >= 3) {
                    state.repeatCount = 0;
                    nextWordLogic();
                } else {
                    hint.innerText = `è¯·è·Ÿè¯»ï¼Œå·²å®Œæˆ: ${state.repeatCount}/3`;
                }
            };
            container.appendChild(b);

        } else if (state.step === 2) { // 2. å¬éŸ³è¯†ä¹‰
            document.getElementById('stage-info').innerText = "å¬éŸ³è¯†ä¹‰";
            display.innerHTML = `<div class="big-word" onclick="speak('${word.en}')">ğŸ”Š</div>`;
            hint.innerText = "ç‚¹å‡»å–‡å­ï¼Œé€‰æ‹©ä¸­æ–‡æ„æ€";
            speak(word.en);
            
            let options = [...state.groupWords].sort(() => Math.random() - 0.5);
            options.forEach(o => {
                let b = document.createElement('div');
                b.className = 'btn';
                b.innerText = o.cn;
                b.onclick = () => {
                    if(o.en === word.en) {
                        b.classList.add('correct');
                        setTimeout(nextWordLogic, 500);
                    } else {
                        b.classList.add('wrong');
                        playSound('miss');
                    }
                };
                container.appendChild(b);
            });

        } else if (state.step === 3) { // 3. çœ‹ä¸­è¯´è‹±
            document.getElementById('stage-info').innerText = "çœ‹ä¸­è¯´è‹±";
            display.innerHTML = `<div class="big-word">${word.cn}</div>`;
            hint.innerText = "å®ƒçš„è‹±è¯­å•è¯æ˜¯ï¼Ÿ";
            
            let options = [...state.groupWords].sort(() => Math.random() - 0.5);
            options.forEach(o => {
                let b = document.createElement('div');
                b.className = 'btn';
                b.innerText = o.en;
                b.onclick = () => {
                    if(o.en === word.en) {
                        b.classList.add('correct');
                        speak(word.en);
                        setTimeout(nextWordLogic, 500);
                    } else {
                        b.classList.add('wrong');
                        playSound('miss');
                    }
                };
                container.appendChild(b);
            });

        } else if (state.step === 4) { // 4. æ‹¼å†™æˆ˜æ–—
            document.getElementById('content-area').style.display = 'none';
            document.getElementById('combat-zone').style.display = 'block';
            document.getElementById('stage-info').innerText = "é­”æ³•å†³æ–— (æ‹¼å†™)";
            
            const old = document.querySelector('.enemy-word');
            if(old) old.remove();

            let enemy = document.createElement('div');
            enemy.className = 'enemy-word';
            enemy.innerText = word.cn;
            enemy.style.top = "100px";
            enemy.style.left = "50%";
            enemy.style.transform = "translateX(-50%)";
            document.getElementById('combat-zone').appendChild(enemy);

            const input = document.getElementById('spell-input');
            input.value = '';
            input.focus();
            input.onkeypress = (e) => {
                if(e.key === 'Enter') {
                    if(input.value.trim().toLowerCase() === word.en.toLowerCase()) {
                        fireSpell(enemy);
                    } else {
                        playSound('miss');
                        input.classList.add('misfire');
                        setTimeout(() => input.classList.remove('misfire'), 500);
                    }
                }
            };
        }
    }

    function fireSpell(target) {
        playSound('cast');
        let bullet = document.createElement('div');
        bullet.className = 'spell-bullet';
        bullet.style.bottom = "160px";
        bullet.style.left = "50%";
        document.getElementById('combat-zone').appendChild(bullet);

        setTimeout(() => {
            bullet.style.transition = "all 0.3s ease-in";
            bullet.style.top = "110px";
            setTimeout(() => {
                playSound('hit');
                bullet.remove();
                target.style.transform = "scale(0) rotate(360deg)";
                target.style.transition = "0.3s";
                setTimeout(() => {
                    target.remove();
                    nextWordLogic();
                }, 200);
            }, 300);
        }, 10);
    }

    function nextWordLogic() {
        state.wordInGroupIdx++;
        // å¦‚æœå½“å‰ç»„çš„å•è¯è¿˜æ²¡è·‘å®Œè¿™ä¸€æ­¥
        if(state.wordInGroupIdx < state.groupWords.length) {
            runStep();
        } else {
            // å½“å‰ç»„æ‰€æœ‰å•è¯è·‘å®Œäº†å½“å‰æ­¥ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥
            state.wordInGroupIdx = 0;
            state.step++;
            if(state.step > 4) {
                // 4æ­¥éƒ½è·‘å®Œäº†ï¼Œè¿™ä¸€ç»„å½»åº•ç»“æŸ
                state.currentGroupIdx++;
                const nextStart = state.currentGroupIdx * 5;
                if(nextStart >= state.unitWords.length) {
                    alert("å…³å¡å®Œæˆï¼å³å°†è¿›å…¥å¤ä¹ æ¨¡å¼ã€‚");
                    location.reload();
                } else {
                    alert("å½“å‰ç»„å®Œæˆï¼å‡†å¤‡å¼€å§‹ä¸‹ä¸€ç»„ 5 ä¸ªå•è¯ã€‚");
                    loadGroup();
                }
            } else {
                runStep();
            }
        }
    }

    function speak(t) {
        if(synth.speaking) synth.cancel();
        let u = new SpeechSynthesisUtterance(t);
        u.lang = 'en-US';
        synth.speak(u);
    }

    init();
</script>
</body>
</html>
